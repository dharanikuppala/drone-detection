<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sky Guardians</title>
    <link
      rel="icon"
      href="{{ url_for('static', filename='Images/DroneD.png') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='alert.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
  </head>
  <body>
    <div class="container">
      <nav>
        <img
          src="{{ url_for('static', filename='Images/sky-logo.png') }}"
          onclick="window.location.href='{{ url_for('index') }}';"
          class="logo"
          alt="Sky Guardians Logo"
        />
      </nav>

      <center>
        <form
          class="form"
          method="post"
          action="{{ url_for('home') }}"
          id="MainForm"
        >
          <p class="title" style="padding-bottom: 10px">Login</p>

          <label>
            <input
              class="input"
              type="email"
              placeholder=""
              required=""
              id="emailInp"
              autocomplete="off"
            />
            <span>Email</span>
          </label>

          <label>
            <input
              class="input"
              type="password"
              placeholder=""
              required=""
              id="pwd"
              autocomplete="off"
            />
            <span>Password</span>
          </label>
          <label style="padding-bottom: 10px"></label>
          <button
            class="submit"
            type="submit"
            formaction="{{ url_for('home') }}"
          >
            Submit
          </button>
          <p class="signin">
            Don't have an account ?
            <a href="{{ url_for('signup') }}">SignUp</a>
          </p>
        </form>
      </center>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-analytics.js";
      import {
        getDatabase,
        get,
        ref,
        child,
      } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
      } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
      const firebaseConfig = {
    apiKey: "AIzaSyBolC7jsJppsWsRlZ2Kl76Bl3l0n7ZERMI",
    authDomain: "sky-guardians.firebaseapp.com",
    projectId: "sky-guardians",
    storageBucket: "sky-guardians.appspot.com",
    messagingSenderId: "114848979559",
    appId: "1:114848979559:web:0c34fc808ab872cb8212c2",
    measurementId: "G-X4G6J90S78"
  };
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getDatabase(app);
      const auth = getAuth(app);
      const dbref = ref(db);

      let EmailInp = document.getElementById("emailInp");
      let PassInp = document.getElementById("pwd");
      let MainForm = document.getElementById("MainForm");

      let SignInUser = (evt) => {
        evt.preventDefault();

        signInWithEmailAndPassword(auth, EmailInp.value, PassInp.value)
          .then((credentials) => {
            get(child(dbref, "users/" + credentials.user.uid)).then(
              (snapshot) => {
                if (snapshot.exists) {
                  sessionStorage.setItem(
                    "user-info",
                    JSON.stringify({
                      firstname: snapshot.val().firstname,
                      lastname: snapshot.val().lastname,
                    })
                  );
                  sessionStorage.setItem(
                    "user-creds",
                    JSON.stringify(credentials.user)
                  );
                  let homeUrl = "{{ url_for('home') }}";
                  window.location.href = homeUrl;
                }
              }
            );
          })
          .catch((error) => {
            // Alert
            let icon = {
              danger: '<span class="material-symbols-outlined">error</span>',
            };
            const showToast = (
              message = "Sample Message",
              toastType = "info",
              duration = 5000
            ) => {
              if (!Object.keys(icon).includes(toastType)) toastType = "info";

              let box = document.createElement("div");
              box.classList.add("toast", `toast-${toastType}`);
              box.innerHTML = ` <div class="toast-content-wrapper">
                                                    <div class="toast-icon">
                                                    ${icon[toastType]}
                                                    </div>
                                                    <div class="toast-message">${message}</div>
                                                    <div class="toast-progress"></div>
                                                    </div>`;
              duration = duration || 5000;
              box.querySelector(".toast-progress").style.animationDuration = `${
                duration / 1000
              }s`;

              let toastAlready = document.body.querySelector(".toast");
              if (toastAlready) {
                toastAlready.remove();
              }

              document.body.appendChild(box);
            };

            showToast("Sorry, unrecognized credentials!!!", "danger", 5000);
            console.log(error.code);
            console.log(error.message);
          });
      };

      MainForm.addEventListener("submit", SignInUser);
    </script>
  </body>
</html>
